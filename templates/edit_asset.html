{% extends "base.html" %}

{% block title %}Редактировать актив #{{ device.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Редактировать актив #{{ device.id }}</h2>
            <a href="{{ url_for('read_assets') }}" class="btn btn-secondary">Назад к списку</a>
        </div>
        <div class="card-body">
            <form action="{{ url_for('update_asset', device_id=device.id) }}" method="post" id="editAssetForm" class="persist-data" novalidate>
                <ul class="nav nav-tabs" id="assetTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main-tab-pane" type="button" role="tab" aria-controls="main-tab-pane" aria-selected="true">Основная информация</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial-tab-pane" type="button" role="tab" aria-controls="financial-tab-pane" aria-selected="false">Финансы и эксплуатация</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="components-tab" data-bs-toggle="tab" data-bs-target="#components-tab-pane" type="button" role="tab" aria-controls="components-tab-pane" aria-selected="false">Компоненты</button>
                    </li>
                </ul>

                <div class="tab-content" id="assetTabContent">
                    <!-- Вкладка "Основная информация" -->
                    <div class="tab-pane fade show active" id="main-tab-pane" role="tabpanel" aria-labelledby="main-tab" tabindex="0">
                        <div class="row mt-3">
                            <!-- Левая колонка -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Название актива <span class="text-danger">*</span></label>
                                    <input type="text" id="name" name="name" class="form-control" value="{{ device.name or '' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="inventory_number" class="form-label">Инвентарный номер</label>
                                    <input type="text" id="inventory_number" name="inventory_number" class="form-control" value="{{ device.inventory_number or '' }}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="asset_type_id" class="form-label">Тип актива <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="asset_type_id" name="asset_type_id" class="form-select" required>
                                            <option value="">Выберите тип...</option>
                                            {% for type in asset_types %}<option value="{{ type.id }}" {% if device.asset_type_id == type.id %}selected{% endif %}>{{ type.name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='asset-types') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новый тип актива"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="manufacturer_id" class="form-label">Производитель <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="manufacturer_id" name="manufacturer_id" class="form-select" required>
                                            <option value="">Выберите производителя...</option>
                                            {% for manufacturer in manufacturers %}<option value="{{ manufacturer.id }}" {% if device.device_model.manufacturer_id == manufacturer.id %}selected{% endif %}>{{ manufacturer.name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='manufacturers') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить нового производителя"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="device_model_id" class="form-label">Модель <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="device_model_id" name="device_model_id" class="form-select" required>
                                            <option value="">Выберите модель...</option>
                                            {% for model in device_models %}<option value="{{ model.id }}" data-manufacturer-id="{{ model.manufacturer.id }}" {% if device.device_model_id == model.id %}selected{% endif %}>{{ model.name }} ({{ model.manufacturer.name }})</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('manage_dictionary', dictionary_type='device-models') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новую модель"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="serial_number" class="form-label">Серийный номер</label>
                                    <input type="text" id="serial_number" name="serial_number" class="form-control" value="{{ device.serial_number or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="mac_address" class="form-label">MAC-адрес</label>
                                    <input type="text" id="mac_address" name="mac_address" class="form-control" value="{{ device.mac_address or '' }}" placeholder="XX:XX:XX:XX:XX:XX">
                                </div>
                                <div class="mb-3">
                                    <label for="ip_address" class="form-label">IP-адрес</label>
                                    <input type="text" id="ip_address" name="ip_address" class="form-control" value="{{ device.ip_address or '' }}" placeholder="192.168.1.100">
                                </div>
                            </div>
                            <!-- Правая колонка -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status_id" class="form-label">Статус <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="status_id" name="status_id" class="form-select" required>
                                            <option value="">Выберите статус...</option>
                                            {% for status in device_statuses %}<option value="{{ status.id }}" {% if device.status_id == status.id %}selected{% endif %}>{{ status.name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='device-statuses') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новый статус"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="location_id" class="form-label">Расположение <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select id="location_id" name="location_id" class="form-select" required>
                                            <option value="">Выберите расположение...</option>
                                            {% for location in locations %}<option value="{{ location.id }}" {% if device.location_id == location.id %}selected{% endif %}>{{ location.name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='locations') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новое расположение"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="department_id" class="form-label">Отдел</label>
                                    <div class="input-group">
                                        <select id="department_id" name="department_id" class="form-select">
                                            <option value="">Не назначен</option>
                                            {% for department in departments %}<option value="{{ department.id }}" {% if device.department_id == department.id %}selected{% endif %}>{{ department.name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='departments') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новый отдел"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="employee_id" class="form-label">Сотрудник</label>
                                    <div class="input-group">
                                        <select id="employee_id" name="employee_id" class="form-select">
                                            <option value="">Не назначен</option>
                                            {% for employee in employees %}<option value="{{ employee.id }}" {% if device.employee_id == employee.id %}selected{% endif %}>{{ employee.last_name }} {{ employee.first_name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('manage_dictionary', dictionary_type='employees') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить нового сотрудника"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="tag-select" class="form-label">Теги</label>
                                    <select 
                                        id="tag-select" 
                                        name="tag_ids" 
                                        multiple
                                        data-existing-tags-data="{{ existing_tags_data|tojson|forceescape }}"
                                    ></select>
                                </div>
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Примечания</label>
                                    <textarea id="notes" name="notes" class="form-control" rows="3">{{ device.notes or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Вкладка "Финансы и эксплуатация" -->
                    <div class="tab-pane fade" id="financial-tab-pane" role="tabpanel" aria-labelledby="financial-tab" tabindex="0">
                        <div class="row mt-3">
                            <!-- Левая колонка -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="supplier_id" class="form-label">Поставщик</label>
                                    <div class="input-group">
                                        <select id="supplier_id" name="supplier_id" class="form-select">
                                            <option value="">Выберите поставщика...</option>
                                            {% for supplier in suppliers %}<option value="{{ supplier.id }}" {% if device.supplier_id == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>{% endfor %}
                                        </select>
                                        <a href="{{ url_for('manage_dictionary', dictionary_type='suppliers') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить нового поставщика"><i class="bi bi-plus-lg"></i></a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="source" class="form-label">Источник</label>
                                    <select id="source" name="source" class="form-select">
                                        <option value="purchase" {% if device.source == 'purchase' %}selected{% endif %}>Покупка</option>
                                        <option value="lease" {% if device.source == 'lease' %}selected{% endif %}>Аренда</option>
                                        <option value="gift" {% if device.source == 'gift' %}selected{% endif %}>Дар</option>
                                        <option value="internal" {% if device.source == 'internal' %}selected{% endif %}>Внутреннее перемещение</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="price" class="form-label">Цена</label>
                                    <input type="number" step="0.01" min="0" id="price" name="price" class="form-control" value="{{ '%.2f'|format(device.price) if device.price is not none else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="purchase_date" class="form-label">Дата покупки/получения</label>
                                    <input type="date" id="purchase_date" name="purchase_date" class="form-control" value="{{ device.purchase_date.strftime('%Y-%m-%d') if device.purchase_date else '' }}">
                                </div>
                            </div>
                            <!-- Правая колонка -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="warranty_end_date" class="form-label">Окончание гарантии</label>
                                    <input type="date" id="warranty_end_date" name="warranty_end_date" class="form-control" value="{{ device.warranty_end_date.strftime('%Y-%m-%d') if device.warranty_end_date else '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="expected_lifespan_years" class="form-label">Ожидаемый срок службы (лет)</label>
                                    <input type="number" min="0" id="expected_lifespan_years" name="expected_lifespan_years" class="form-control" value="{{ device.expected_lifespan_years or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label for="current_wear_percentage" class="form-label">Процент износа</label>
                                    <input type="number" min="0" max="100" id="current_wear_percentage" name="current_wear_percentage" class="form-control" value="{{ device.current_wear_percentage or '' }}" placeholder="Например, 10 для 10%">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Вкладка "Компоненты" -->
                    <div class="tab-pane fade" id="components-tab-pane" role="tabpanel" aria-labelledby="components-tab" tabindex="0">
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>Загрузка компонентов</h5>
                                <div class="mb-3">
                                    <label for="components-file" class="form-label">JSON файл с компонентами</label>
                                    <input type="file" id="components-file" class="form-control" accept=".json">
                                    <small class="form-text text-muted">Загрузите JSON файл с информацией о компонентах</small>
                                </div>
                                <button type="button" id="upload-components-btn" class="btn btn-primary"><i class="bi bi-upload"></i> Загрузить компоненты</button>
                                <hr class="my-4">
                                <h5>Текущая конфигурация</h5>
                                {% if device.components %}
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Тип</th>
                                            <th>Модель</th>
                                            <th>Серийный номер</th>
                                            <th>Характеристики</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for comp in device.components %}
                                        <tr>
                                            <td>
                                                {% if comp.component_type == 'cpu' %}
                                                    <i class="bi bi-cpu"></i> CPU
                                                {% elif comp.component_type == 'ram' %}
                                                    <i class="bi bi-memory"></i> RAM
                                                {% elif comp.component_type == 'storage' %}
                                                    <i class="bi bi-device-hdd"></i> Storage
                                                {% elif comp.component_type == 'gpu' %}
                                                    <i class="bi bi-gpu-card"></i> GPU
                                                {% elif comp.component_type == 'motherboard' %}
                                                    <i class="bi bi-motherboard"></i> Motherboard
                                                {% endif %}
                                            </td>
                                            <td>{{ comp.name }}</td>
                                            <td>{{ comp.serial_number or '-' }}</td>
                                            <td>
                                                {% if comp.component_type == 'cpu' %}
                                                    Cores: {{ comp.cores }}, Threads: {{ comp.threads }}{% if comp.base_clock_mhz %}, {{ comp.base_clock_mhz }} MHz{% endif %}
                                                {% elif comp.component_type == 'ram' %}
                                                    Size: {{ comp.size_mb }} MB{% if comp.speed_mhz %}, {{ comp.speed_mhz }} MHz{% endif %}{% if comp.form_factor %}, {{ comp.form_factor }}{% endif %}
                                                {% elif comp.component_type == 'storage' %}
                                                    Type: {{ comp.type_label }}, {{ comp.capacity_gb }} GB{% if comp.interface %}, {{ comp.interface }}{% endif %}
                                                {% elif comp.component_type == 'gpu' %}
                                                    {% if comp.memory_mb %}Memory: {{ comp.memory_mb }} MB{% endif %}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p class="text-muted">Компоненты не загружены</p>
                                {% endif %}
                                <hr class="my-4">
                                <h5>История изменений</h5>
                                {% if device.component_history %}
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Дата</th>
                                            <th>Тип изменения</th>
                                            <th>Данные</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for history in device.component_history | reverse %}
                                        <tr>
                                            <td>{{ history.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                            <td>
                                                {% if history.change_type == 'ADD' %}
                                                    <span class="badge bg-success">Добавлено</span>
                                                {% elif history.change_type == 'UPDATE' %}
                                                    <span class="badge bg-warning">Обновлено</span>
                                                {% elif history.change_type == 'REMOVE' %}
                                                    <span class="badge bg-danger">Удалено</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-secondary view-json-btn"
                                                        data-json='{{ history.component_snapshot | tojson | forceescape }}'>
                                                    <i class="bi bi-file-code"></i> Показать данные
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <p class="text-muted">История изменений пуста</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                    {% if request.session.get('is_superuser') %}
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Сохранить изменения</button>
                    {% else %}
                    <div class="alert alert-warning">У вас нет прав для редактирования этого актива.</div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', path='js/tom-select-init.js') }}"></script>
    <script src="{{ url_for('static', path='js/form_persistence.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Синхронизация полей "Производитель" и "Модель"
            const manufacturerSelect = document.getElementById('manufacturer_id');
            const modelSelect = document.getElementById('device_model_id');
            const allModels = Array.from(modelSelect.options).slice(1); // Сохраняем все модели (кроме placeholder)
            
            // При изменении производителя → фильтруем модели
            manufacturerSelect.addEventListener('change', async function() {
                const manufacturerId = this.value;
                
                if (!manufacturerId) {
                    // Если производитель не выбран, показываем все модели
                    modelSelect.innerHTML = '<option value="">Выберите модель...</option>';
                    allModels.forEach(opt => modelSelect.appendChild(opt.cloneNode(true)));
                    return;
                }
                
                // Загружаем модели для выбранного производителя
                try {
                    const response = await fetch(`/dictionaries/api/models/by-manufacturer/${manufacturerId}`);
                    const models = await response.json();
                    
                    modelSelect.innerHTML = '<option value="">Выберите модель...</option>';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        option.setAttribute('data-manufacturer-id', manufacturerId);
                        modelSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Ошибка загрузки моделей:', error);
                }
            });
            
            // При выборе модели → автоматически выбираем производителя
            modelSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (!selectedOption.value) return;
                
                const manufacturerId = selectedOption.getAttribute('data-manufacturer-id');
                if (manufacturerId) {
                    manufacturerSelect.value = manufacturerId;
                }
            });
        });

        // JavaScript для загрузки компонентов
        const uploadBtn = document.getElementById('upload-components-btn');
        const fileInput = document.getElementById('components-file');
        
        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', async function() {
                const file = fileInput.files[0];
                if (!file) {
                    alert('Пожалуйста, выберите JSON файл');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Загрузка...';
                    
                    const response = await fetch('/{{ device.id }}/components/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`Успешно загружено ${result.count} компонентов`);
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert('Ошибка: ' + (error.detail || 'Неизвестная ошибка'));
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке:', error);
                    alert('Ошибка при загрузке файла');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Загрузить компоненты';
                }
            });
        }
    </script>
{% endblock %}