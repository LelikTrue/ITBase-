{% extends "base.html" %}

{% block title %}Добавить актив{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Добавить новый актив</h2>
        <a href="{{ url_for('read_assets') }}" class="btn btn-secondary">Назад к списку</a>
    </div>

    <form action="{{ url_for('create_asset') }}" method="post" id="addAssetForm" class="persist-data" novalidate>
        <ul class="nav nav-tabs" id="assetTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main-tab-pane" type="button" role="tab" aria-controls="main-tab-pane" aria-selected="true">Основная информация</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial-tab-pane" type="button" role="tab" aria-controls="financial-tab-pane" aria-selected="false">Финансы и эксплуатация</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-pane" type="button" role="tab" aria-controls="import-pane" aria-selected="false">Импорт из Агента</button>
            </li>
        </ul>

        <div class="tab-content" id="assetTabContent">
            <!-- Вкладка "Основная информация" -->
            <div class="tab-pane fade show active" id="main-tab-pane" role="tabpanel" aria-labelledby="main-tab" tabindex="0">
                <div class="row mt-3">
                    <!-- Левая колонка -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Название актива <span class="text-danger">*</span></label>
                            <input type="text" id="name" name="name" class="form-control" value="{{ asset.name if asset else '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="asset_type_id" class="form-label">Тип актива <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="asset_type_id" name="asset_type_id" class="form-select" required>
                                     <option value="">Выберите тип...</option>
                                    {% for asset_type in asset_types %}<option value="{{ asset_type.id }}">{{ asset_type.name }}</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='asset-types') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новый тип актива"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="manufacturer_id" class="form-label">Производитель <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="manufacturer_id" name="manufacturer_id" class="form-select" required>
                                    <option value="">Выберите производителя...</option>
                                    {% for manufacturer in manufacturers %}<option value="{{ manufacturer.id }}">{{ manufacturer.name }}</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='manufacturers') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить нового производителя"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="device_model_id" class="form-label">Модель <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="device_model_id" name="device_model_id" class="form-select" required>
                                    <option value="">Выберите модель...</option>
                                    {% for model in device_models %}<option value="{{ model.id }}" data-manufacturer-id="{{ model.manufacturer.id }}">{{ model.name }} ({{ model.manufacturer.name }})</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('manage_dictionary', dictionary_type='device-models') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новую модель"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="serial_number" class="form-label">Серийный номер</label>
                            <input type="text" id="serial_number" name="serial_number" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="mac_address" class="form-label">MAC-адрес</label>
                            <input type="text" id="mac_address" name="mac_address" class="form-control" placeholder="XX:XX:XX:XX:XX:XX">
                        </div>
                        <div class="mb-3">
                            <label for="ip_address" class="form-label">IP-адрес</label>
                            <input type="text" id="ip_address" name="ip_address" class="form-control" placeholder="192.168.1.100">
                        </div>
                    </div>
                    <!-- Правая колонка -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="status_id" class="form-label">Статус <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="status_id" name="status_id" class="form-select" required>
                                    <option value="">Выберите статус...</option>
                                    {% for status in device_statuses %}<option value="{{ status.id }}">{{ status.name }}</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='device-statuses') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новый статус"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="location_id" class="form-label">Расположение <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select id="location_id" name="location_id" class="form-select" required>
                                    <option value="">Выберите расположение...</option>
                                    {% for location in locations %}<option value="{{ location.id }}">{{ location.name }}</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='locations') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новое расположение"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label for="department_id" class="form-label">Отдел</label>
                            <div class="input-group">
                                <select id="department_id" name="department_id" class="form-select">
                                    <option value="">Не назначен</option>
                                    {% for department in departments %}<option value="{{ department.id }}">{{ department.name }}</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('quick_add_dictionary_item_page', dictionary_type='departments') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить новый отдел"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tag-select" class="form-label">Теги</label>
                            <select id="tag-select" name="tag_ids" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Примечания</label>
                            <textarea id="notes" name="notes" class="form-control" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Вкладка "Финансы и эксплуатация" -->
            <div class="tab-pane fade" id="financial-tab-pane" role="tabpanel" aria-labelledby="financial-tab" tabindex="0">
                <div class="row mt-3">
                    <!-- Левая колонка -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="supplier_id" class="form-label">Поставщик</label>
                            <div class="input-group">
                                <select id="supplier_id" name="supplier_id" class="form-select">
                                    <option value="">Выберите поставщика...</option>
                                    {% for supplier in suppliers %}<option value="{{ supplier.id }}">{{ supplier.name }}</option>{% endfor %}
                                </select>
                                <a href="{{ url_for('manage_dictionary', dictionary_type='suppliers') }}?next={{ request.path }}" class="btn btn-outline-secondary save-state-link" title="Добавить нового поставщика"><i class="bi bi-plus-lg"></i></a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="source" class="form-label">Источник</label>
                            <select id="source" name="source" class="form-select">
                                <option value="purchase" selected>Покупка</option>
                                <option value="lease">Аренда</option>
                                <option value="gift">Дар</option>
                                <option value="internal">Внутреннее перемещение</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Цена</label>
                            <input type="number" step="0.01" min="0" id="price" name="price" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="purchase_date" class="form-label">Дата покупки/получения</label>
                            <input type="date" id="purchase_date" name="purchase_date" class="form-control">
                        </div>
                    </div>
                    <!-- Правая колонка -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="warranty_end_date" class="form-label">Окончание гарантии</label>
                            <input type="date" id="warranty_end_date" name="warranty_end_date" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="expected_lifespan_years" class="form-label">Ожидаемый срок службы (лет)</label>
                            <input type="number" min="0" id="expected_lifespan_years" name="expected_lifespan_years" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="current_wear_percentage" class="form-label">Процент износа</label>
                            <input type="number" min="0" max="100" id="current_wear_percentage" name="current_wear_percentage" class="form-control" placeholder="Например, 10 для 10%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
            
            <!-- Вкладка "Импорт" -->
            <div class="tab-pane fade" id="import-pane" role="tabpanel" aria-labelledby="import-tab" tabindex="0">
                <div class="text-center py-5">
                    <i class="bi bi-robot fs-1 text-primary mb-3"></i>
                    <h4>Автоматическое создание</h4>
                    <p class="text-muted">Загрузите JSON-файл, сгенерированный агентом (ITBase_Agent.exe).<br>Система автоматически создаст модель, производителя и заполнит компоненты.</p>
                    
                    <div class="row justify-content-center mt-4">
                        <div class="col-md-6">
                            <input type="file" id="agent-file" class="form-control" accept=".json">
                            <button id="btn-import" type="button" class="btn btn-primary mt-3 w-100">
                                <i class="bi bi-upload"></i> Загрузить и создать
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', path='js/tom-select-init.js') }}"></script>
    <script src="{{ url_for('static', path='js/form_persistence.js') }}"></script>
    <script>
        // Валидация формы перед отправкой
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[action="{{ url_for('create_asset') }}"]');
            
            if (form) {
                form.addEventListener('submit', function(event) {
                    // Проверяем обязательные поля
                    const requiredFields = [
                        { id: 'name', label: 'Название актива' },
                        { id: 'asset_type_id', label: 'Тип актива' },
                        { id: 'manufacturer_id', label: 'Производитель' },
                        { id: 'device_model_id', label: 'Модель' },
                        { id: 'status_id', label: 'Статус' },
                        { id: 'location_id', label: 'Расположение' }
                    ];
                    
                    let hasErrors = false;
                    const errors = [];
                    
                    requiredFields.forEach(field => {
                        const input = document.getElementById(field.id);
                        if (input && (!input.value || input.value === '')) {
                            hasErrors = true;
                            errors.push(field.label);
                            input.classList.add('is-invalid');
                        } else if (input) {
                            input.classList.remove('is-invalid');
                        }
                    });
                    
                    if (hasErrors) {
                        event.preventDefault();
                        alert('Пожалуйста, заполните все обязательные поля:\n- ' + errors.join('\n- '));
                        // Переключаемся на первую вкладку, если ошибки там
                        const mainTab = document.getElementById('main-tab');
                        if (mainTab) {
                            mainTab.click();
                        }
                        return false;
                    }
                });
            }
            
            // Синхронизация полей "Производитель" и "Модель"
            const manufacturerSelect = document.getElementById('manufacturer_id');
            const modelSelect = document.getElementById('device_model_id');
            const allModels = Array.from(modelSelect.options).slice(1); // Сохраняем все модели (кроме placeholder)
            
            // При изменении производителя → фильтруем модели
            manufacturerSelect.addEventListener('change', async function() {
                const manufacturerId = this.value;
                
                if (!manufacturerId) {
                    // Если производитель не выбран, показываем все модели
                    modelSelect.innerHTML = '<option value="">Выберите модель...</option>';
                    allModels.forEach(opt => modelSelect.appendChild(opt.cloneNode(true)));
                    return;
                }
                
                // Загружаем модели для выбранного производителя
                try {
                    const response = await fetch(`/dictionaries/api/models/by-manufacturer/${manufacturerId}`);
                    const models = await response.json();
                    
                    modelSelect.innerHTML = '<option value="">Выберите модель...</option>';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        option.setAttribute('data-manufacturer-id', manufacturerId);
                        modelSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Ошибка загрузки моделей:', error);
                }
            });
            
            // При выборе модели → автоматически выбираем производителя
            modelSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (!selectedOption.value) return;
                
                const manufacturerId = selectedOption.getAttribute('data-manufacturer-id');
                if (manufacturerId) {
                    manufacturerSelect.value = manufacturerId;
                }
            });

            // --- IMPORT LOGIC ---
            document.getElementById('btn-import').addEventListener('click', async function() {
                const fileInput = document.getElementById('agent-file');
                const btn = this;
                
                if (!fileInput.files[0]) {
                    alert("Выберите файл!");
                    return;
                }
            
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
            
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Создание...';
            
                    const response = await fetch('/import', {
                        method: 'POST',
                        body: formData
                    });
            
                    if (response.ok) {
                        const data = await response.json();
                        // РЕДИРЕКТ на страницу редактирования созданного актива
                        if (data.redirect_url) {
                             window.location.href = data.redirect_url;
                        } else {
                             alert("Успешно, но нет URL для редиректа");
                             btn.disabled = false;
                        }
                    } else {
                        const err = await response.json();
                        alert("Ошибка: " + (err.detail || "Unknown error"));
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-upload"></i> Загрузить и создать';
                    }
                } catch (e) {
                    console.error(e);
                    alert("Ошибка сети");
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-upload"></i> Загрузить и создать';
                }
            });
        });
    </script>
{% endblock %}